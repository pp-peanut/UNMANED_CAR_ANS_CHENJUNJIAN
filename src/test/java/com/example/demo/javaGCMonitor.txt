
#!/bin/bash

BOOTPATH=$(cd `dirname $0`; pwd)
gclog=${BOOTPATH}/gc.log
echo `ps -ef | grep java | grep '\-DappName' | grep -v grep | awk '{print $2}'`

echo "$(date +%F% %T):check process $pid............">>${gclog}
flag=1
fgc1=`jstat -gcutil "$pid" | sed -n '2'p | awk '{print $8}'`
while(($flag==1))
do
    fgc2=`jstat -gcutil "$pid" | sed -n '2'p | awk '{print $8}'`
    echo "$(date +%F%n%T):---------------start----------------">>${gclog}
    echo "$(date +%F%n%T):fgc2=$fgc2, fgc1=$fgc1" >> ${gclog}
    echo "$(date +%F%n%T):-------------top--------------">>${gclog}
    top -b| head -12 >> ${gclog}
    div=`expr $fgc2 - $fgc1`
    if [ $div -gt 0 ]
    then
        echo "$(date +%F%n%T):------------------------------------出现了fgc---------------------------------" >> ${gclog}
        echo "$(date +%F%n%T):------------------------------------GC 情况-----------------------------------" >> ${gclog}
        echo `jstat -gcutil "$pid"` >> ${gclog}
        for i in {1..3}
        do
            #查找消耗最高线程id
            # 加上-b不会出现乱码
            tid=`top -H -b -p $pid | head -10 | sed -n '8'p | awk '{print($1)}'`
            echo "tid=$tid"
            tid16=`printf "%x" $tid`
            echo "$(date +%F%n%T):cpu 消耗最高线程 id 是${tid16}啊" >>${gclog}
            echo "$(date +%F%n%T):cpu 消耗最高线程 id 是${tid16}"
            echo "$(date +%F%n%T):-------------堆栈信息--${tid}--${tid16}---------------" >> ${gclog}

            jstack $pid | grep -A 20 $tid16 >> ${gclog}
            jstack $pid > $pid$tid.jstack
        done
    fi
    echo "$(date +%F%n%T):---------------end----------------">>${gclog}
    fgc1=$fgc2
    sleep 10
done
